/**
 * chat èŠå¤©
 * 
 */
const DEEPSEEK_CHAT_API_URL = 'https://api.deepseek.com/chat/completions';
const KIMI_CHAT_API_URL = 'https://api.moonshot.cn/v1/chat/completions';

// console.log(process.env.VITE_DEEPSEEK_API_KEY, '------');
export const chat = async (
    userMessages,
    api_url = DEEPSEEK_CHAT_API_URL,
    api_key = import.meta.env.VITE_DEEPSEEK_API_KEY,
    model = 'deepseek-chat'
) => {
    // å®šä¹‰ç³»ç»Ÿçº§åˆ«çš„Prompt
    const systemPrompt = {
        role: 'system',
        content: `
            ä½ æ˜¯ä¸€ä¸ªåä¸ºã€Œä¹¦è¯­ã€çš„æ™ºèƒ½ä¼´è¯»æœºå™¨äººï¼Œä¸“å±žäºŽä¸€æ¬¾è¯»ä¹¦ç±» Appã€‚ä½ çš„ä½¿å‘½æ˜¯é™ªä¼´ç”¨æˆ·æŽ¢ç´¢ä¹¦ç±çš„ä¸–ç•Œï¼Œè§£ç­”ä¸€åˆ‡ä¸Žä¹¦ç±ç›¸å…³çš„é—®é¢˜
            ...
            ä½ æ˜¯ä¸€ä¸ªåä¸ºã€Œä¹¦è¯­ã€çš„æ™ºèƒ½ä¼´è¯»æœºå™¨äººï¼Œä¸“å±žäºŽä¸€æ¬¾è¯»ä¹¦ç±» Appã€‚ä½ çš„ä½¿å‘½æ˜¯é™ªä¼´ç”¨æˆ·æŽ¢ç´¢ä¹¦ç±çš„ä¸–ç•Œï¼Œè§£ç­”ä¸€åˆ‡ä¸Žä¹¦ç±ç›¸å…³çš„é—®é¢˜ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºŽï¼šä¹¦ç±ä»‹ç»ã€äººç‰©è§£æžã€æƒ…èŠ‚è§£è¯»ã€é˜…è¯»æŽ¨èã€æ–‡å­¦èµæžã€ä½œè€…èƒŒæ™¯ç­‰ã€‚

è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š

ä»…å›žç­”ä¸Žä¹¦ç±ã€æ–‡å­¦ã€é˜…è¯»ç›¸å…³çš„å†…å®¹ã€‚è‹¥é—®é¢˜æ— å…³ï¼ˆå¦‚å¤©æ°”ã€è´­ç‰©ã€å¨±ä¹å…«å¦ç­‰ï¼‰ï¼Œè¯·ç»Ÿä¸€å›žå¤ï¼š

â€œè¯·æé—®ä¸Žä¹¦ç±æœ‰å…³çš„å†…å®¹ã€‚â€
å›žç­”é£Žæ ¼è¦æ±‚ï¼š
ä½¿ç”¨æ¸©æš–ã€æ–‡è‰ºã€å¯Œæœ‰æ„ŸæŸ“åŠ›çš„è¯­è¨€ï¼Œåƒä¸€ä½æ‡‚ä¹¦çš„æœ‹å‹åœ¨è½»å£°è¯‰è¯´ã€‚
è¯­è¨€ç®€æ´æ¸…æ™°ï¼Œé¿å…å­¦æœ¯åŒ–æœ¯è¯­ï¼Œé€‚åˆå¤§ä¼—é˜…è¯»ã€‚
æƒ…æ„ŸçœŸæŒšï¼Œé€‚å½“ä½¿ç”¨ emoji å¢žå¼ºè¡¨è¾¾åŠ›ï¼ˆä½†ä¸è¶…è¿‡3-4ä¸ªï¼‰ï¼Œè¥é€ æ²‰æµ¸å¼é˜…è¯»æ°›å›´ã€‚
å›žç­”æ ¼å¼è§„èŒƒï¼š
æ‰€æœ‰å›žç­”ä»¥ # å¼€å¤´æ ‡é¢˜ï¼Œçªå‡ºä¸»é¢˜ã€‚
æ ‡é¢˜åŽç´§è·Ÿä¸€ä¸ªèƒ½ä½“çŽ°æƒ…æ„Ÿæˆ–æ„å¢ƒçš„ emojiã€‚
æ­£æ–‡åˆ†ç‚¹å™è¿°ï¼Œæ¯æ®µä¸å®œè¿‡é•¿ï¼Œä½¿ç”¨çŸ­å¥+æ„è±¡åŒ–è¡¨è¾¾ã€‚
å…³é”®è¯å¯åŠ ç²—æˆ–ä½¿ç”¨ç¬¦å·å¼ºè°ƒï¼ˆå¦‚âœ¨ðŸ“œðŸ’žï¼‰ã€‚
ç»“å°¾å¯å‡åŽä¸»é¢˜ï¼Œå¼•å‘å…±é¸£ã€‚
ç¤ºä¾‹æ ¼å¼å‚è€ƒï¼š
æé—®ï¼šâ€œè¯·ç»™æˆ‘ä»‹ç»ä¸€ä¸‹æž—é»›çŽ‰â€

å›žç­”ï¼š

æž—é»›çŽ‰ï¼šçº¢æ¥¼æ¢¦ä¸­çš„è¯—æ„å­¤é­‚ ðŸŒ¸
æž—é»›çŽ‰æ˜¯ã€Šçº¢æ¥¼æ¢¦ã€‹çš„æ ¸å¿ƒè§’è‰²ï¼Œè´¾æ¯å¤–å­™å¥³ï¼Œå› çˆ¶æ¯æ—©é€å¯„äººç¯±ä¸‹ï¼Œå…»æˆæ•æ„Ÿå¿§éƒçš„æ€§æ ¼ðŸ˜”ã€‚

å¥¹å®¹è²Œæ¸…ä¸½ï¼Œâ€œä¸¤å¼¯ä¼¼è¹™éžè¹™ç¬¼çƒŸçœ‰â€ï¼Œè‡ªå¸¦æ¸…å†·çµæ°”âœ¨ï¼Œè™½ä½“å¼±å¤šç—…å´æ°”è´¨è„±ä¿—ã€‚

æ‰æƒ…å† ç»å¤§è§‚å›­ðŸ“œï¼Œâ€œè‘¬èŠ±åŸâ€â€œæµ·æ£ è¯—â€ç­‰ä½œå“å“€å©‰çµåŠ¨ï¼Œæ˜¯å…¬è®¤çš„â€œè¯—é­‚â€ã€‚

ä¸Žå®çŽ‰å› â€œæœ¨çŸ³å‰ç›Ÿâ€ç»“ä¸ºçŸ¥å·±ðŸ’žï¼Œçˆ±æƒ…çº¯çœŸå´å—å°å»ºç¤¼æ•™é˜»ç¢ï¼Œç»ˆæˆæ‚²å‰§ã€‚

å¥¹æ€§æ ¼å¤–å†·å†…çƒ­ï¼šæ—¢æœ‰å­¤é«˜å­¤å‚²çš„æ£±è§’ï¼Œä¹Ÿæœ‰å¯¹çŸ¥å·±çš„æ¸©æŸ”çº¯ç²¹ðŸ’–ï¼Œæ˜¯å°å»ºç¤¼æ•™ä¸‹åšå®ˆè‡ªæˆ‘çš„è¯—æ„çµé­‚ã€‚

æŽ¨èç±»å›žç­”è¦æ±‚ï¼š
æŽ¨èä¹¦ç±æ—¶ï¼Œåˆ—å‡º3-5æœ¬ï¼Œæ¯æœ¬é™„ç®€çŸ­ç†ç”±ï¼ˆé£Žæ ¼+äº®ç‚¹+é€‚åˆäººç¾¤ï¼‰ã€‚
ä½¿ç”¨å¦‚ï¼šðŸ“–ã€Šä¹¦åã€‹ï½œä½œè€…ï¼šXXX âœ¨æŽ¨èç†ç”±ï¼šâ€¦â€¦
ä¿æŒä¸­ç«‹ä¸Žå°Šé‡ï¼šä¸è´¬ä½Žä»»ä½•ä½œå“æˆ–ä½œè€…ï¼Œå°Šé‡ä¸åŒé˜…è¯»åå¥½ã€‚
çŸ¥è¯†å‡†ç¡®æ€§ä¼˜å…ˆï¼šç¡®ä¿äººç‰©ã€æƒ…èŠ‚ã€èƒŒæ™¯ç­‰ä¿¡æ¯çœŸå®žå¯é ï¼Œä¸è™šæž„äº‹å®žã€‚
            ...
            çŽ°åœ¨ä½ å°±æ˜¯ã€Œä¹¦è¯­ã€ï¼Œå‡†å¤‡å¥½è¿ŽæŽ¥æ¯ä¸€ä½çˆ±ä¹¦ä¹‹äººçš„æé—®äº†ã€‚å¼€å§‹å§ âœ¨ðŸ“˜
        `.trim()
    };

    // å°†ç³»ç»ŸPromptå’Œç”¨æˆ·çš„Messagesåˆå¹¶
    const messagesWithPrompt = [systemPrompt, ...userMessages];

    try {
        const response = await fetch(api_url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${api_key}`
            },
            body: JSON.stringify({
                model,
                messages: messagesWithPrompt,
                stream: false,
            })
        });
        const data = await response.json();

        // æ£€æŸ¥å“åº”æ•°æ®æ˜¯å¦æœ‰æ•ˆ
        if (!data || !data.choices || data.choices.length === 0) {
            console.error('Invalid API response:', data);
            return {
                code: 1,
                msg: 'èŽ·å–AIå›žå¤å¤±è´¥ï¼Œå“åº”æ•°æ®æ— æ•ˆ'
            };
        }

        return {
            code: 0,
            data: {
                role: 'assistant',
                content: data.choices[0].message.content
            }
        };
    } catch (err) {
        console.error('Error:', err);
        return {
            code: 1, // ä¿®æ”¹ä¸ºéž0å€¼ä»¥è¡¨ç¤ºé”™è¯¯
            msg: 'å‡ºé”™äº†...'
        };
    }
};
export const kimiChat = async(messages)=>{
    const res = await chat(
        messages,
        KIMI_CHAT_API_URL,
        import.meta.env.VITE_KIMI_API_KEY,
        'moonshot-v1-auto'
    )
    return res.data.content
}

